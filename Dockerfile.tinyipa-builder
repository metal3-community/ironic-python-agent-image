FROM ubuntu:24.04

# Build arguments for architecture-specific builds
ARG TARGETARCH
ARG TARGETPLATFORM

# Environment setup for non-interactive installs
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=UTC
ENV PYTHONUNBUFFERED=1
ENV IPA_SOURCE_DIR=/opt/stack/ironic-python-agent

# Setup timezone first
RUN echo 'tzdata tzdata/Areas select Etc' | debconf-set-selections && \
    echo 'tzdata tzdata/Zones/Etc select UTC' | debconf-set-selections && \
    apt update && \
    apt install -y tzdata

# Install essential build dependencies
RUN apt install -y \
    build-essential \
    wget \
    curl \
    cpio \
    gzip \
    tar \
    squashfs-tools \
    xorriso \
    git \
    python3 \
    python3-pip \
    python3-dev \
    python3-setuptools \
    python3-wheel \
    kpartx \
    parted \
    util-linux \
    sudo \
    unzip \
    gawk \
    file \
    rsync \
    && rm -rf /var/lib/apt/lists/*

# Install x86_64 specific packages for ISO building
RUN if [ "$TARGETARCH" = "amd64" ]; then \
        apt update && \
        apt install -y isolinux syslinux-utils && \
        rm -rf /var/lib/apt/lists/*; \
    fi

# Create necessary directories
RUN mkdir -p /opt/stack /workspace

# Clone ironic-python-agent repository
RUN git clone https://github.com/openstack/ironic-python-agent.git /opt/stack/ironic-python-agent

RUN git clone https://github.com/openstack/requirements.git /opt/stack/requirements

# Set working directory
WORKDIR /workspace

COPY *.sh /workspace/
COPY udhcpc.script /workspace/
COPY Makefile /workspace/
COPY build_files/* /workspace/build_files/
COPY build_files/${TARGETARCH}/* /workspace/build_files/

# Default command
CMD ["/bin/bash"]
